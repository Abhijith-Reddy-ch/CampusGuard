<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>

<body>
    <nav>
        <div class="brand">CampusGuard Security</div>
        <ul></ul>
    </nav>
    <div id="notification-area"></div>

    <main>
        <!-- SOS Section -->
        <div class="card" style="border-left: 5px solid red;">
            <h3 style="color:red;">ðŸš¨ Active SOS Alerts</h3>
            <ul id="sosList">
                <li>No Active Alerts</li>
            </ul>
            <div id="map" style="height: 300px; margin-top: 1rem; border-radius: 4px;"></div>
        </div>

        <!-- V16: Live Feed -->
        <div class="card">
            <h3>Live Gate Feed</h3>
            <div style="display: flex; gap: 1rem;">
                <div style="flex: 1;">
                    <h4>Recent Entries</h4>
                    <ul id="feedEntry" style="list-style: none; padding: 0;"></ul>
                </div>
                <div style="flex: 1;">
                    <h4>Recent Exits</h4>
                    <ul id="feedExit" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/main.js"></script>
    <script>
        let map, markers = [];

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            const user = getSession();
            if (user.role !== 'guard' && user.role !== 'admin') {
                window.location.href = '../index.html';
                return;
            }

            initMap();
            refreshData();
            setInterval(refreshData, 5000); // Poll every 5s
        });

        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        async function refreshData() {
            // Load SOS
            const alerts = await apiCall('/api/sos');
            const list = document.getElementById('sosList');
            const active = alerts.filter(a => a.status === 'Active');

            list.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            if (active.length === 0) {
                list.innerHTML = '<li>No Active Alerts</li>';
            } else {
                active.forEach(a => {
                    list.innerHTML += `<li><strong>${a.studentId}</strong> @ ${new Date(a.time).toLocaleTimeString()} <button onclick="resolve('${a.id}')">Resolve</button></li>`;
                    if (a.location && a.location.lat) {
                        const m = L.marker([a.location.lat, a.location.lng]).addTo(map).bindPopup("SOS: " + a.studentId);
                        markers.push(m);
                        map.setView([a.location.lat, a.location.lng], 15);
                    }
                });
            }

            // V16: Live Feed
            const entries = await apiCall('/api/entries'); // Ensure limit 10
            const exits = await apiCall('/api/exits');

            renderFeed('feedEntry', entries.slice(0, 10)); // Show last 10
            renderFeed('feedExit', exits.slice(0, 10));
        }

        function renderFeed(elemId, data) {
            const ul = document.getElementById(elemId);
            ul.innerHTML = '';
            if (!data || data.length === 0) {
                ul.innerHTML = '<li>No activity</li>';
                return;
            }
            data.forEach(x => {
                ul.innerHTML += `
                    <li style="border-bottom: 1px solid #eee; padding: 5px 0;">
                        <strong>${x.studentId}</strong> (${x.department})
                        <br><small>${new Date(x.time).toLocaleTimeString()}</small>
                    </li>
                `;
            });
        }

        async function resolve(id) {
            await apiCall(`/api/sos/${id}`, 'PUT', { status: 'Resolved' });
            refreshData();
        }
    </script>
</body>

</html>